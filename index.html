<!DOCTYPE html5>
<html>
	<head>
		<title>Sweeper</title>
		<script>
let viewport = {
	width: 30,
	height: 30
}

function handleMessage(socketMessage) {
	var message = JSON.parse(socketMessage.data);
	console.log("got a new message", message);

	// Update position display
	var locSpan = document.getElementById("location")
	locSpan.innerText = JSON.stringify(message.Position);

	for (y = 0; y < message.Data.length; y++) {
		for (x = 0; x < message.Data[y].length; x++) {
			var fe = document.getElementById("field-" + y + "-" + x);
			fe.innerText = String.fromCharCode(message.Data[y][x]);
		}
	}
}

function setup() {
	// Build playing field
	var field = document.getElementById("field");
	for (y = 0; y < viewport.width; y++) {
		var row = document.createElement("div");
		row.classList.add("fieldRow");
		for (x = 0; x < viewport.height; x++) {
			var elem = document.createElement("div");
			elem.id = "field-" + y + "-" + x;
			elem.classList.add("fieldElement");
			elem.dataset.x = x;
			elem.dataset.y = y;
			row.appendChild(elem);
		}
		field.appendChild(row);
	}

	// TODO: Add handlers for other events?
	var ws = new WebSocket("ws://localhost:8080/ws"); // TODO: get hostname from location
	ws.addEventListener("message", handleMessage);

	// Add event handlers for inputs
	document.addEventListener("keydown", event => {
		var request = {
			Kind: "move",
			X: 0,
			Y: 0
		}

		switch (event.key) {
			case "ArrowLeft":
				request.X = -1;
				break;
			case "ArrowRight":
				request.X = 1;
				break;
			case "ArrowUp":
				request.Y = -1;
				break;
			case "ArrowDown":
				request.Y += 1;
				break;
			default:
				console.log("unhandled key event", event);
				return;
		}

		console.log("sending request", request);

		ws.send(JSON.stringify(request));
	})

	var field = document.getElementById("field");
	field.addEventListener("mouseup", event => {
		console.log("mouse event", event);
		event.preventDefault();
		var x = parseInt(event.target.dataset.x);
		var y = parseInt(event.target.dataset.y);
		var request = {
			Kind: "uncover",
			X: x,
			Y: y
		}
		ws.send(JSON.stringify(request));
	});

}
		</script>
		<style>
		.fieldElement {
			width: 1em;
			height: 1em;
			border: 1px solid black;
			font: monospace;
			text-align: center;
		}
		.fieldRow {
			display: flex;
		}
		#field {
			font-size: 200%;
		}
		</style>
	</head>
	<body>
		<span id="location"><!-- filled async --></span>
		<div id="field">
		</div>
		<script>setup();</script>
	</body>
</html>
